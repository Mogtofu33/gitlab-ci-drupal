################################################################################
# [WIP] Use Gitlab pages to publish the results on one page.
# 
# docker run --rm -it -v "/home/mog/code/gitlab-ci-drupal:/builds" -w /builds --env-file local/.env alpine:latest sh
################################################################################

.publish_gitlab_pages_template:
  image: alpine:latest
  script:
    - apk --no-cache add jq tree git curl
    - git clone https://gitlab.com/mog33/reports--gitlab-ci-drupal.git public
    - cp -r ./report-*/ ./public/
    - cd ./public
    # @TODO use CI_BUILD_TOKEN when working.
    - |
      j=$(curl -s -H "PRIVATE-TOKEN: $MY_GITLAB_TOKEN" $CI_API_V4_URL/projects/$CI_PROJECT_ID/pipelines/$CI_PIPELINE_ID/jobs || true);
      f=$(ls -d report-* | jq -R -s -c 'split("\n")[:-1]');
      d=$(tree -J --dirsfirst -f --noreport -I "." -I "index.html|README.md");
      v=$(jq -n env);
      echo "var data={\"jobs\":"$j",\"dirs\":"$d",\"flat\":"$f",\"vars\":"$v" }" > js/data.js
  artifacts:
    paths:
    - public